<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baroud Auction ğŸ”¥</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* ØªØµÙ…ÙŠÙ… Dark Mode Ù…Ø±Ø¹Ø¨ */
        body {
            background-color: #0d0d0d;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 600px; margin: auto; }
        
        /* ÙƒØ±Øª Ø§Ù„Ù…Ø²Ø§Ø¯ */
        .auction-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
        }
        
        h1 { color: #00ff88; text-shadow: 0 0 10px #00ff88; margin-bottom: 5px; }
        .live-badge { background: red; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8em; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .price-box {
            font-size: 3.5em;
            font-weight: bold;
            color: #00ff88;
            margin: 15px 0;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .timer {
            font-size: 1.8em;
            color: #ff3333;
            font-weight: bold;
            background: #220000;
            display: inline-block;
            padding: 5px 20px;
            border-radius: 10px;
            border: 1px solid #ff3333;
        }
        
        input {
            width: 70%;
            padding: 15px;
            font-size: 1.2em;
            background: #000;
            border: 1px solid #444;
            color: white;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 10px;
        }

        .btn-bid {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            color: #000;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.1s;
        }
        .btn-bid:active { transform: scale(0.95); }

        .feed { margin-top: 30px; text-align: right; border-top: 1px solid #333; padding-top: 20px; }
        .feed-item { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-right: 3px solid #00ff88; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¥ Baroud Auction</h1>
    <span class="live-badge">LIVE ğŸ”´</span>
    
    <div class="auction-card" id="auction-card">
        <h2 id="item-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</h2>
        <p id="item-desc" style="color:#aaa;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
        
        <div class="timer" id="timer">--:--:--</div>
        <div class="price-box" id="current-price">$...</div>
        
        <p style="color: #aaa; margin-top: 20px;">Ø£Ù‚Ù„ Ø²ÙŠØ§Ø¯Ø©: <span id="min-inc">$1</span></p>
        
        <input type="number" id="bid-amount" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø©">
        <button class="btn-bid" onclick="placeBid()">Ø²Ø§ÙŠØ¯ Ø§Ù„Ø¢Ù† ğŸ”¨</button>
    </div>

    <div class="feed">
        <h3>ğŸ“Š Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª</h3>
        <div id="bids-list">
            <div style="color: #555; text-align: center;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰...</div>
        </div>
    </div>
</div>

<script>
    // 1. Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ© (ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ âœ…)
    const supabaseUrl = 'https://lnamqekqpqyrcwpdbeuf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuYW1xZWtxcHF5cmN3cGRiZXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDM1NjEsImV4cCI6MjA4NjA3OTU2MX0.SFrtJOP2aBwe2PvOXQRb-IWOzbMghVaMwi0CZC0x1WE';
    
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Ø±Ù‚Ù… Ø§Ù„Ù…Ø²Ø§Ø¯ Ø§Ù„Ù„ÙŠ Ø±Ø­ Ù†Ø¹Ø±Ø¶Ù‡ (ØªØ£ÙƒØ¯Ù†Ø§ Ø¥Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø±Ù‚Ù… 1)
    const auctionId = 1; 

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    async function init() {
        console.log("Starting connection...");
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¯ Ø±Ù‚Ù… 1
        const { data, error } = await supabase
            .from('auctions')
            .select('*')
            .eq('id', auctionId)
            .single();

        if (error) {
            alert("âŒ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message);
            document.getElementById('item-title').innerText = "Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„";
            return;
        }

        if (!data) {
            alert("âš ï¸ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø±Ù‚Ù… 1 ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²!");
            document.getElementById('item-title').innerText = "Ø§Ù„Ù…Ø²Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
            return;
        }

        // Ø¥Ø°Ø§ ÙˆØµÙ„Ù†Ø§ Ù‡ÙˆÙ†ØŒ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø¬Ø­ 100%
        updateUI(data);

        // Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© (Realtime)
        supabase.channel('public:auctions')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'auctions', filter: `id=eq.${auctionId}` }, payload => {
                updateUI(payload.new);
            })
            .subscribe();

        // Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª
        supabase.channel('public:bids')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bids', filter: `auction_id=eq.${auctionId}` }, payload => {
                addBidToFeed(payload.new.amount);
            })
            .subscribe();
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
    function updateUI(auction) {
        document.getElementById('item-title').innerText = auction.title;
        document.getElementById('item-desc').innerText = auction.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
        document.getElementById('current-price').innerText = `$${auction.current_price}`;
        document.getElementById('min-inc').innerText = `$${auction.min_increment}`;
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯
        startTimer(new Date(auction.ends_at));
    }

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø©
    async function placeBid() {
        const amount = document.getElementById('bid-amount').value;
        if (!amount) return alert('Ø­Ø· Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ§ ÙˆØ­Ø´!');

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø© ØªØ­ØªØ§Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„.
        // Ø±Ø­ Ù†Ø¬Ø±Ø¨ Ù†Ø¨Ø¹Øª Ø§Ù„Ø·Ù„Ø¨ØŒ Ø¥Ø°Ø§ ÙØ´Ù„ Ø±Ø­ ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø³Ø¨Ø¨.
        const { data, error } = await supabase.rpc('place_bid', {
            p_auction_id: auctionId,
            p_amount: Number(amount)
        });

        if (error) {
            alert('âš ï¸ ' + error.message + '\n(Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ØªØ²Ø§ÙŠØ¯)');
        } else if (!data.success) {
            alert('ğŸš« ' + data.message);
        } else {
            alert('âœ… ' + data.message);
            document.getElementById('bid-amount').value = ''; // ÙØ¶ÙŠ Ø§Ù„Ø®Ø§Ù†Ø©
        }
    }

    // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
    let timerInterval;
    function startTimer(endTime) {
        if (timerInterval) clearInterval(timerInterval); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        
        timerInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            if (distance < 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø²Ø§Ø¯ ğŸ";
                document.getElementById('timer').style.color = "gray";
                return;
            }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            document.getElementById('timer').innerText = `${hours}h ${minutes}m ${seconds}s`;
        }, 1000);
    }

    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ø±ÙŠØ·
    function addBidToFeed(amount) {
        const list = document.getElementById('bids-list');
        const item = document.createElement('div');
        item.className = 'feed-item';
        item.innerHTML = `ğŸ’µ Ù…Ø²Ø§ÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù‚ÙŠÙ…Ø© <b>$${amount}</b>`;
        list.prepend(item);
    }

    // Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡.. Ø´ØºÙ„!
    init();
</script>

</body>
</html>
