<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baroud Auction ðŸ”¥</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0d0d0d; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 2px solid #333; margin-top: 20px; }
        .price { font-size: 3em; color: #00ff88; font-weight: bold; margin: 10px 0; }
        .timer { font-size: 1.5em; color: #ff3333; margin-bottom: 20px; }
        input { padding: 15px; width: 60%; font-size: 1.2em; text-align: center; border-radius: 10px; border: none; margin-bottom: 10px; }
        button { padding: 15px; width: 30%; font-size: 1.2em; background: #00ff88; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .feed { margin-top: 20px; text-align: right; font-size: 0.9em; color: #aaa; border-top: 1px solid #333; padding-top: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ”¥ Ù…Ø²Ø§Ø¯ Ø¨Ø§Ø±ÙˆØ¯ ðŸ”¥</h1>
    
    <div class="card">
        <h2 id="title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <div class="timer" id="timer">--:--:--</div>
        <div class="price" id="price">$---</div>
        
        <div>
            <input type="number" id="amount" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <button onclick="bid()">Ø²Ø§ÙŠØ¯!</button>
        </div>
    </div>

    <div class="feed" id="feed">
        <h3>Ø¢Ø®Ø± Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª:</h3>
        <div id="bids-list"></div>
    </div>
</div>

<script>
    // âš ï¸âš ï¸âš ï¸ ØºÙŠØ± Ù‡ÙˆÙ„ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Supabase âš ï¸âš ï¸âš ï¸
    const supabaseUrl = 'https://lnamqekqpqyrcwpdbeuf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuYW1xZWtxcHF5cmN3cGRiZXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MDM1NjEsImV4cCI6MjA4NjA3OTU2MX0.SFrtJOP2aBwe2PvOXQRb-IWOzbMghVaMwi0CZC0x1WE';
    
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Ø±Ù‚Ù… Ø§Ù„Ù…Ø²Ø§Ø¯ (ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¹Ù…Ù„Øª ÙˆØ§Ø­Ø¯ Ø¨Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ø±Ù‚Ù…Ù‡ 1)
    let auctionId = 1; 

    async function init() {
        const { data, error } = await supabase.from('auctions').select('*').eq('id', auctionId).single();
        if(error) console.log(error);
        if(data) updateUI(data);

        supabase.channel('auctions').on('postgres_changes', { event: '*', schema: 'public', table: 'auctions' }, payload => {
            updateUI(payload.new);
        }).subscribe();
        
        supabase.channel('bids').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bids' }, payload => {
            addFeed(payload.new.amount);
        }).subscribe();
    }

    function updateUI(data) {
        document.getElementById('title').innerText = data.title;
        document.getElementById('price').innerText = '$' + data.current_price;
        startTimer(new Date(data.ends_at));
    }

    async function bid() {
        const amount = document.getElementById('amount').value;
        // Ù‡ÙˆÙ† Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ØŒ Ø±Ø­ Ù†ÙØªØ±Ø¶Ù‡ 1 Ù„Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        const { data, error } = await supabase.rpc('place_bid', { p_auction_id: auctionId, p_amount: amount });
        
        if(error) alert(error.message);
        else if(!data.success) alert(data.message);
        else alert('âœ… ' + data.message);
    }

    function startTimer(end) {
        setInterval(() => {
            const now = new Date();
            const diff = end - now;
            if(diff < 0) return document.getElementById('timer').innerText = "Ø§Ù†ØªÙ‡Ù‰!";
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('timer').innerText = m + "Ø¯ : " + s + "Ø«";
        }, 1000);
    }

    function addFeed(amount) {
        const div = document.createElement('div');
        div.innerText = `ðŸ”¨ Ø´Ø®Øµ Ø²Ø§ÙŠØ¯ Ø¨Ù€ $${amount}`;
        document.getElementById('bids-list').prepend(div);
    }

    init();
</script>
</body>
</html>
